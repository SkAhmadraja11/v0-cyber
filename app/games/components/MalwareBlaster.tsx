"use client"

import { useState, useEffect, useRef } from "react"
import { Button } from "@/components/ui/button"
import { Bug, Shield, Skull, Zap } from "lucide-react"

export default function MalwareBlasterGame({ onComplete }: { onComplete: (score: number) => void }) {
    const [score, setScore] = useState(0)
    const [timeLeft, setTimeLeft] = useState(30)
    const [gameState, setGameState] = useState<"start" | "playing" | "gameover">("start")
    const [threats, setThreats] = useState<{ id: number, x: number, y: number, type: "virus" | "file" }[]>([])
    const requestRef = useRef<number>(0)

    const spawnThreat = () => {
        const id = Date.now() + Math.random()
        const x = Math.random() * 80 + 10 // %
        const y = -10 // start above
        const type = Math.random() > 0.3 ? "virus" : "file"
        setThreats(prev => [...prev, { id, x, y, type }])
    }

    useEffect(() => {
        if (gameState !== "playing") return

        const interval = setInterval(() => {
            spawnThreat()
        }, 800)

        const timer = setInterval(() => {
            setTimeLeft(t => {
                if (t <= 1) {
                    setGameState("gameover")
                    return 0
                }
                return t - 1
            })
        }, 1000)

        // Game Loop
        const loop = () => {
            setThreats(prev => {
                const next = prev.map(t => ({ ...t, y: t.y + 0.5 })).filter(t => t.y < 100)
                return next
            })
            requestRef.current = requestAnimationFrame(loop)
        }
        loop()

        return () => {
            clearInterval(interval)
            clearInterval(timer)
            cancelAnimationFrame(requestRef.current!)
        }
    }, [gameState])

    const handleClick = (id: number, type: "virus" | "file") => {
        if (gameState !== "playing") return

        if (type === "virus") {
            setScore(s => s + 100)
            // Play zap sound effect logic here
        } else {
            setScore(s => Math.max(0, s - 50)) // Penalty for deleting safe files
        }
        setThreats(prev => prev.filter(t => t.id !== id))
    }

    return (
        <div className="h-[500px] relative bg-slate-900 overflow-hidden border-2 border-primary rounded-lg select-none cursor-crosshair">
            {gameState === "start" && (
                <div className="absolute inset-0 z-10 flex flex-col items-center justify-center bg-black/80 text-white">
                    <Shield className="w-16 h-16 text-primary mb-4" />
                    <h2 className="text-3xl font-bold mb-2">Malware Blaster</h2>
                    <p className="mb-6 text-center max-w-sm">Click the VIRUSES (Red Skulls/Bugs).<br />Do NOT click Safe Files (Blue).</p>
                    <Button onClick={() => setGameState("playing")} size="lg">Start Defense</Button>
                </div>
            )}

            {gameState === "gameover" && (
                <div className="absolute inset-0 z-10 flex flex-col items-center justify-center bg-black/80 text-white animate-in zoom-in">
                    <h2 className="text-3xl font-bold mb-2">System Secure!</h2>
                    <p className="text-xl mb-6">Score: {score}</p>
                    <Button onClick={() => onComplete(score)} size="lg">Finish</Button>
                </div>
            )}

            {/* GUI */}
            <div className="absolute top-4 left-4 text-white font-mono text-xl z-10">Score: {score}</div>
            <div className="absolute top-4 right-4 text-white font-mono text-xl z-10">Time: {timeLeft}s</div>

            {/* Game Area */}
            {threats.map(t => (
                <div
                    key={t.id}
                    onMouseDown={() => handleClick(t.id, t.type)}
                    className="absolute transform -translate-x-1/2 cursor-pointer transition-transform active:scale-150"
                    style={{ left: `${t.x}%`, top: `${t.y}%` }}
                >
                    {t.type === "virus" ? (
                        Math.random() > 0.5 ? <Skull className="w-12 h-12 text-red-500 drop-shadow-[0_0_10px_rgba(239,68,68,0.8)]" /> :
                            <Bug className="w-12 h-12 text-orange-500 drop-shadow-[0_0_10px_rgba(249,115,22,0.8)]" />
                    ) : (
                        <div className="w-10 h-12 bg-blue-500/20 border border-blue-400 rounded flex items-center justify-center">
                            <span className="text-xs text-blue-300 font-mono">FILE</span>
                        </div>
                    )}
                </div>
            ))}
        </div>
    )
}
